{% extends "base.html" %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: { toyota: { red: '#EB0A1E' } }
            }
        }
    }
</script>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">

    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <span class="w-3 h-8 bg-toyota-red rounded-full block"></span>
                Ladijski razporedi
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2 ml-6">Upravljanje z ladijskimi najavami in arhivi.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="loadSchedules()"
                class="p-2 rounded-full bg-gray-100 dark:bg-white/10 hover:bg-gray-200 transition-colors">
                <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
            </button>
        </div>
    </div>

    <!-- Active Schedules -->
    <div class="mb-12">
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
            <i data-lucide="file-clock" class="w-6 h-6 text-toyota-red"></i> Aktivni Razporedi
        </h2>

        <div id="activeContainer" class="flex flex-wrap gap-4 animate-fade-in">
            <!-- Pills will be injected here -->
            <div class="animate-pulse w-32 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
            <div class="animate-pulse w-32 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
        </div>

        <!-- Viewer Area (Expands when a pill is clicked) -->
        <div id="viewerSection"
            class="hidden mt-8 bg-white dark:bg-[#1c1c1e] rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800 overflow-hidden transition-all duration-300">
            <!-- Viewer Header -->
            <div
                class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-white/5">
                <div class="flex items-center gap-4">
                    <div id="fileTypeIcon"
                        class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-sm">PL
                    </div>
                    <div>
                        <h3 id="viewFilename" class="font-bold text-lg text-gray-900 dark:text-white">Filename.xlsx</h3>
                        <p id="viewMeta" class="text-xs text-gray-500">Uploaded 2 mins ago</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="btnDownload"
                        class="px-5 py-2.5 rounded-full bg-white dark:bg-white/10 border border-gray-200 dark:border-gray-700 font-bold hover:bg-gray-50 transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export
                    </button>
                    <button id="btnArchive"
                        class="px-5 py-2.5 rounded-full bg-gray-900 dark:bg-white text-white dark:text-black font-bold hover:bg-gray-800 hover:scale-105 transition-all flex items-center gap-2 shadow-lg shadow-gray-500/20">
                        <i data-lucide="archive" class="w-4 h-4"></i> Arhiviraj
                    </button>
                </div>
            </div>

            <!-- Excel Content -->
            <div class="p-6 overflow-x-auto">
                <div id="sheetContent" class="prose dark:prose-invert max-w-none text-sm">
                    <!-- Table renders here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Archive Section -->
    <div class="border-t border-gray-200 dark:border-gray-800 pt-8">
        <button onclick="toggleArchive()" class="w-full flex justify-between items-center group">
            <h2
                class="text-xl font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2 group-hover:text-toyota-red transition-colors">
                <i data-lucide="archive" class="w-6 h-6 text-gray-400"></i> Zgodovina / Arhiv
            </h2>
            <i data-lucide="chevron-down" id="archiveChevron" class="w-5 h-5 transition-transform"></i>
        </button>

        <div id="archiveContainer"
            class="hidden mt-6 flex flex-wrap gap-3 opacity-0 transition-opacity duration-300 bg-gray-50 dark:bg-black/20 p-6 rounded-3xl">
            <!-- Archived Pills -->
            <p class="text-gray-500 italic w-full text-center py-4">Prazno</p>
        </div>
    </div>

</div>

<script>
    lucide.createIcons();
    let currentSchedules = [];
    let activeScheduleId = null;

    async function loadSchedules() {
        try {
            const res = await fetch('/api/toyota/schedules');
            currentSchedules = await res.json();
            render();
        } catch (e) {
            console.error(e);
        }
    }

    function render() {
        const activeContainer = document.getElementById('activeContainer');
        const archiveContainer = document.getElementById('archiveContainer');

        activeContainer.innerHTML = '';
        archiveContainer.innerHTML = '';

        const active = currentSchedules.filter(s => s.status === 'active');
        const archived = currentSchedules.filter(s => s.status === 'archived');

        // Render Active
        if (active.length === 0) {
            activeContainer.innerHTML = `<p class="text-gray-400 italic">Ni aktivnih razporedov.</p>`;
        } else {
            active.forEach(s => {
                const pill = createPill(s);
                activeContainer.appendChild(pill);
            });
        }

        // Render Archived
        if (archived.length === 0) {
            archiveContainer.innerHTML = `<p class="text-gray-500 italic w-full text-center">Ni arhiviranih datotek.</p>`;
        } else {
            archived.forEach(s => {
                const pill = createPill(s, true);
                archiveContainer.appendChild(pill);
            });
        }

        lucide.createIcons();
    }

    function createPill(s, isArchive = false) {
        const div = document.createElement('div');
        // Pill Styling
        const baseClass = isArchive
            ? "flex items-center gap-3 px-5 py-3 rounded-full bg-white dark:bg-white/5 border border-gray-200 dark:border-gray-700 text-gray-500 hover:bg-gray-50 cursor-pointer transition-all hover:border-gray-400"
            : "flex items-center gap-3 px-6 py-4 rounded-full bg-white dark:bg-[#2c2c2e] shadow-sm hover:shadow-lg border border-gray-100 dark:border-gray-700 cursor-pointer transition-all transform hover:-translate-y-1 group";

        div.className = baseClass;

        // Type Color
        let colorClass = "bg-gray-500";
        if (s.type === 'PL') colorClass = "bg-blue-500";
        if (s.type === 'CZ') colorClass = "bg-green-500";
        if (s.type === 'UA') colorClass = "bg-yellow-500";

        div.innerHTML = `
            <div class="w-2.5 h-2.5 rounded-full ${colorClass}"></div>
            <span class="font-bold text-sm md:text-base truncate max-w-[200px]">${s.filename}</span>
            <span class="text-xs text-gray-400 ml-2 border-l border-gray-200 pl-2">${new Date(s.created_at).toLocaleDateString()}</span>
        `;

        div.onclick = () => openSchedule(s);
        return div;
    }

    async function openSchedule(s) {
        activeScheduleId = s.id;

        // UI Highlight
        // Reset all active highlights if any (not strictly implemented but ok)

        const viewer = document.getElementById('viewerSection');
        viewer.classList.remove('hidden');

        // Setup Header
        document.getElementById('viewFilename').innerText = s.filename;
        document.getElementById('viewMeta').innerText = `Uploaded: ${new Date(s.created_at).toLocaleString()}`;

        const iconInfo = {
            'PL': { bg: 'bg-blue-500', txt: 'PL' },
            'CZ': { bg: 'bg-green-500', txt: 'CZ' },
            'UA': { bg: 'bg-yellow-500', txt: 'UA' }
        }[s.type] || { bg: 'bg-gray-500', txt: '?' };

        const icon = document.getElementById('fileTypeIcon');
        icon.className = `w-12 h-12 rounded-2xl flex items-center justify-center font-bold text-white text-lg shadow-lg shadow-gray-300/50 ${iconInfo.bg}`;
        icon.innerText = iconInfo.txt;

        // Prepare Buttons
        document.getElementById('btnDownload').onclick = () => {
            window.location.href = `/api/toyota/schedules/download/${s.id}`;
        };

        const btnArchive = document.getElementById('btnArchive');
        if (s.status === 'archived') {
            btnArchive.classList.add('hidden');
        } else {
            btnArchive.classList.remove('hidden');
            btnArchive.onclick = () => archiveSchedule(s.id);
        }

        // Load Content
        const contentDiv = document.getElementById('sheetContent');
        contentDiv.innerHTML = `<div class="flex justify-center py-10"><i data-lucide="loader-2" class="animate-spin w-8 h-8 text-toyota-red"></i></div>`;
        lucide.createIcons();

        try {
            const fileRes = await fetch(`/api/toyota/schedules/download/${s.id}`);
            const blob = await fileRes.blob();
            const buffer = await blob.arrayBuffer();

            const wb = XLSX.read(buffer);
            const ws = wb.Sheets[wb.SheetNames[0]];
            const html = XLSX.utils.sheet_to_html(ws, { id: 'scheduleTable', editable: false });

            contentDiv.innerHTML = html;

            // Style the table
            const table = contentDiv.querySelector('table');
            if (table) {
                table.classList.add('w-full', 'border-collapse', 'table-auto');
                table.querySelectorAll('td, th').forEach(td => {
                    td.classList.add('border', 'border-gray-200', 'dark:border-gray-700', 'p-2', 'text-right');
                });
            }

        } catch (e) {
            contentDiv.innerHTML = `<p class="text-red-500">Error loading file preview.</p>`;
        }
    }

    async function archiveSchedule(id) {
        if (!confirm("Premaknem v arhiv?")) return;

        try {
            await fetch('/api/toyota/schedules/archive', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            // Close viewer
            document.getElementById('viewerSection').classList.add('hidden');
            loadSchedules(); // Reload
        } catch (e) {
            alert("Error archiving: " + e.message);
        }
    }

    function toggleArchive() {
        const c = document.getElementById('archiveContainer');
        c.classList.toggle('hidden');
        if (!c.classList.contains('hidden')) {
            setTimeout(() => c.classList.remove('opacity-0'), 10);
        } else {
            c.classList.add('opacity-0');
        }
        document.getElementById('archiveChevron').classList.toggle('rotate-180');
    }

    // Init
    loadSchedules();
</script>

<style>
    /* Table Styles Override */
    #sheetContent table {
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
        width: 100%;
    }

    #sheetContent th {
        background-color: #f3f4f6;
        color: #374151;
        font-weight: 600;
        text-align: left;
    }

    .dark #sheetContent th {
        background-color: #374151;
        color: #e5e7eb;
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}