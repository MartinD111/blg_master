{% extends "base.html" %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: { toyota: { red: '#EB0A1E' } }
            }
        }
    }
</script>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">

    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <span class="w-3 h-8 bg-toyota-red rounded-full block"></span>
                Toyota DIZ Splitter
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2 ml-6">Upload .txt file to automatically split into PL, CZ,
                UA groups.</p>
        </div>
    </div>

    <!-- Main Card -->
    <div
        class="bg-white dark:bg-[#1c1c1e] rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-16 text-center">

        <div
            class="w-24 h-24 rounded-[2.5rem] bg-gray-100 dark:bg-white/5 mx-auto mb-8 flex items-center justify-center">
            <i data-lucide="split" class="w-10 h-10 text-gray-800 dark:text-white"></i>
        </div>
        <h2 class="text-3xl font-bold mb-4">Upload DIZ File</h2>
        <p class="text-gray-500 mb-10 max-w-lg mx-auto">Drag & Drop the .txt file containing DIZ lines.</p>

        <div id="dropZoneDiz"
            class="relative group cursor-pointer h-48 flex items-center justify-center bg-gray-50 dark:bg-black/20 rounded-[2.5rem] border-2 border-dashed border-gray-300 dark:border-gray-700 hover:border-toyota-red transition-all">
            <input type="file" id="dizFile" accept=".txt" class="hidden">
            <div class="text-center pointer-events-none">
                <h3 id="dizFileName" class="text-xl font-bold text-gray-700 dark:text-gray-200">Drop .txt File Here</h3>
                <p class="text-sm text-gray-400 mt-2">or click to browse</p>
            </div>
        </div>

        <div id="dizResults" class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
            <!-- Filled by JS -->
        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    const dropZoneDiz = document.getElementById('dropZoneDiz');
    const dizInput = document.getElementById('dizFile');

    dropZoneDiz.addEventListener('click', () => dizInput.click());
    dizInput.addEventListener('change', () => handleDiz(dizInput.files[0]));
    dropZoneDiz.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneDiz.classList.add('border-toyota-red'); });
    dropZoneDiz.addEventListener('dragleave', (e) => { dropZoneDiz.classList.remove('border-toyota-red'); });
    dropZoneDiz.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneDiz.classList.remove('border-toyota-red');
        handleDiz(e.dataTransfer.files[0]);
    });

    function handleDiz(file) {
        if (!file) return;
        document.getElementById('dizFileName').innerText = file.name;

        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split(/\r?\n/);
            const groups = { PLWAW: [], CZPRG: [], UAIEV: [] };

            lines.forEach(line => {
                if (!line.trim()) return;
                if (line.includes('PLWAW') || line.includes('PLAWA')) groups.PLWAW.push(line);
                else if (line.includes('CZPRG') || line.includes('ATVIE')) groups.CZPRG.push(line);
                else if (line.includes('UAIEV')) groups.UAIEV.push(line);
            });

            renderDizResults(groups);
        };
        reader.readAsText(file);
    }

    function renderDizResults(groups) {
        const container = document.getElementById('dizResults');
        container.innerHTML = '';
        container.classList.remove('hidden');

        Object.entries(groups).forEach(([key, lines]) => {
            if (lines.length === 0) return;
            const weight = lines.reduce((sum, l) => {
                const m = l.match(/(\d{5})CB/);
                return sum + (m ? parseInt(m[1]) : 0);
            }, 0);

            const div = document.createElement('div');
            div.className = "bg-white dark:bg-white/5 rounded-[2rem] p-6 border border-gray-100 dark:border-gray-700 hover:scale-[1.02] transition-transform";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl">${key}</h3>
                    <span class="bg-gray-100 dark:bg-white/10 px-3 py-1 rounded-lg text-xs font-bold">${lines.length}x</span>
                </div>
                <div class="mb-6 text-center py-4 bg-gray-50 dark:bg-black/20 rounded-xl">
                    <span class="text-xs uppercase text-gray-400">Total Weight</span>
                    <div class="text-2xl font-black">${weight.toLocaleString()} <span class="text-sm font-normal text-gray-400">kg</span></div>
                </div>
                <button onclick="downloadTxt('${key}', this)" data-content="${encodeURIComponent(lines.join('\n'))}" class="w-full py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> Download .txt
                </button>
             `;
            container.appendChild(div);
        });
        lucide.createIcons();
    }

    window.downloadTxt = function (name, btn) {
        const content = decodeURIComponent(btn.getAttribute('data-content'));
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}_${new Date().getTime()}.txt`;
        a.click();
    };
</script>
{% endblock %}