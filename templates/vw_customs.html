{% extends "base.html" %}

{% block content %}
<!-- Tool Specific Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                borderRadius: {
                    '4xl': '2rem',
                },
                colors: {
                    surface: {
                        light: '#f2f4f7',
                        dark: '#0b0b0b',
                        card: '#ffffff',
                        cardDark: '#1c1c1e',
                    },
                    primary: {
                        DEFAULT: '#0050d5',
                        dark: '#5c9dff'
                    }
                },
                animation: {
                    'bounce-slight': 'bounce-slight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both',
                    'fade-in': 'fadeIn 0.5s ease-out forwards',
                },
                keyframes: {
                    'bounce-slight': {
                        '0%': { transform: 'scale(0.95)' },
                        '100%': { transform: 'scale(1)' }
                    },
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'translateY(10px)' },
                        '100%': { opacity: '1', transform: 'translateY(0)' }
                    }
                }
            }
        }
    }
</script>
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Main App Wrapper -->
<div id="vw-customs-tool"
    class="bg-transparent text-gray-900 dark:text-gray-100 min-h-screen flex flex-col selection:bg-primary selection:text-white">

    <main class="flex-grow p-4 md:p-8 max-w-5xl mx-auto w-full flex flex-col gap-6">

        <!-- Header (Reduced Padding) -->
        <div class="flex flex-col items-center justify-center pt-2 md:pt-4">
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-gray-900 dark:text-gray-100">Carinjenje</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Volkswagen Customs Operations</p>
        </div>

        <!-- Navigation Tabs (Bubbly Modern Style) -->
        <div
            class="relative flex flex-wrap justify-center items-center gap-2 mx-auto p-1.5 bg-gray-100/50 dark:bg-white/5 backdrop-blur-sm rounded-full border border-gray-200/50 dark:border-white/10 w-fit">

            <button onclick="switchTab('customs')" id="tab-customs"
                class="relative z-10 px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-out flex items-center gap-2 group">
                <i data-lucide="wrench" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity"></i>
                <span>Customs Helper</span>
            </button>

            <button onclick="switchTab('atr')" id="tab-atr"
                class="relative z-10 px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-out flex items-center gap-2 group">
                <i data-lucide="scan-line" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity"></i>
                <span>A.TR Extractor</span>
            </button>

            <button onclick="switchTab('hs')" id="tab-hs"
                class="relative z-10 px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-out flex items-center gap-2 group">
                <i data-lucide="file-archive" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity"></i>
                <span>HS Code</span>
            </button>

            <button onclick="switchTab('coc')" id="tab-coc"
                class="relative z-10 px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-out flex items-center gap-2 group">
                <i data-lucide="file-check" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity"></i>
                <span>CoC Extractor</span>
            </button>

        </div>

        <!-- Content Area -->
        <div class="relative min-h-[400px]">

            <!-- TAB 1: Customs Helper (WIP) -->
            <div id="content-customs" class="tab-content hidden animate-fade-in">
                <div
                    class="bg-surface-card dark:bg-surface-cardDark border border-gray-200 dark:border-gray-700/50 rounded-[2.5rem] p-12 text-center shadow-2xl shadow-gray-200/20 dark:shadow-none">
                    <div
                        class="w-20 h-20 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="wrench" class="w-10 h-10 text-primary dark:text-primary-dark"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Customs Helper</h2>
                    <p class="text-gray-500 max-w-md mx-auto">This module will assist with 1 TON declarations, T2L
                        processing, and document validation logic.</p>
                    <div class="mt-8">
                        <span
                            class="inline-flex items-center px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 border border-gray-200 dark:border-gray-700">
                            Coming Soon
                        </span>
                    </div>
                </div>
            </div>

            <!-- TAB 2: A.TR Extractor (Active) -->
            <div id="content-atr" class="tab-content hidden animate-fade-in">
                <!-- Upload Area -->
                <div id="drop-zone-atr"
                    class="relative group overflow-hidden bg-surface-card dark:bg-surface-cardDark border-[3px] border-dashed border-gray-200 dark:border-gray-700 rounded-[2.5rem] p-16 text-center cursor-pointer transition-all hover:border-indigo-500/50 hover:shadow-2xl hover:shadow-indigo-500/5 mb-8">
                    <input type="file" id="file-input-atr" class="hidden" accept=".pdf, .jpg, .jpeg, .png">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    </div>
                    <div class="relative z-10 flex flex-col items-center gap-4">
                        <div
                            class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-3xl mb-2 group-hover:scale-110 transition-transform duration-300 shadow-sm">
                            <i data-lucide="scan-line" class="w-10 h-10 text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Upload A.TR Document</h2>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Supported: .pdf, .jpg, .png</p>
                        <button onclick="document.getElementById('file-input-atr').click()"
                            class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3.5 rounded-full font-semibold shadow-lg shadow-indigo-600/30 transition-all active:scale-95 flex items-center gap-2 tracking-wide">
                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                            Select File
                        </button>
                    </div>
                </div>

                <!-- Results Table -->
                <div id="results-area-atr" class="hidden">
                    <div
                        class="bg-surface-card dark:bg-surface-cardDark border border-gray-200 dark:border-gray-800 rounded-3xl overflow-hidden shadow-xl">
                        <div
                            class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white">Analysis Results</h3>
                            <button onclick="clearResultsAtr()"
                                class="text-sm text-gray-500 hover:text-red-500 transition-colors font-bold px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Clear</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-gray-100/50 dark:bg-black/20 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-4">Filename</th>
                                        <th class="px-6 py-4">A.TR Number</th>
                                        <th class="px-6 py-4">Invoice Number</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-atr" class="divide-y divide-gray-200 dark:divide-gray-800">
                                    <!-- JS Injection -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Loading -->
                <div id="loading-atr" class="hidden flex-col items-center justify-center py-12">
                    <div
                        class="w-12 h-12 border-4 border-indigo-500/30 border-t-indigo-600 rounded-full animate-spin mb-4">
                    </div>
                    <p class="text-indigo-500 font-medium animate-pulse">Analyzing document...</p>
                </div>
            </div>

            <!-- TAB 3: HS Code Extractor (Active) -->
            <div id="content-hs" class="tab-content hidden animate-fade-in">
                <!-- Upload Area -->
                <div id="drop-zone-hs"
                    class="relative group overflow-hidden bg-surface-card dark:bg-surface-cardDark border-[3px] border-dashed border-gray-200 dark:border-gray-700 rounded-[2.5rem] p-16 text-center cursor-pointer transition-all hover:border-purple-500/50 hover:shadow-2xl hover:shadow-purple-500/5 mb-8">
                    <input type="file" id="file-input-hs" class="hidden" accept=".zip, .xlsx, .xls">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    </div>
                    <div class="relative z-10 flex flex-col items-center gap-4">
                        <div
                            class="bg-purple-50 dark:bg-purple-900/20 p-5 rounded-3xl mb-2 group-hover:scale-110 transition-transform duration-300 shadow-sm">
                            <i data-lucide="file-archive" class="w-10 h-10 text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Upload Excel or ZIP</h2>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Supported: .xlsx, .xls, .zip (with
                            multiple Excels)</p>
                        <button onclick="document.getElementById('file-input-hs').click()"
                            class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-8 py-3.5 rounded-full font-semibold shadow-lg shadow-purple-600/30 transition-all active:scale-95 flex items-center gap-2 tracking-wide">
                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                            Select File
                        </button>
                    </div>
                </div>

                <!-- Results Table -->
                <div id="results-area-hs" class="hidden">
                    <div
                        class="bg-surface-card dark:bg-surface-cardDark border border-gray-200 dark:border-gray-800 rounded-3xl overflow-hidden shadow-xl">
                        <div
                            class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white">Extracted Data</h3>
                            <div class="flex gap-2">
                                <button onclick="downloadHsExcel()"
                                    class="text-sm text-green-600 hover:text-green-700 font-bold px-3 py-1 rounded-lg bg-green-50 dark:bg-green-900/20">Download
                                    Excel</button>
                                <button onclick="clearResultsHs()"
                                    class="text-sm text-gray-500 hover:text-red-500 font-bold px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Clear</button>
                            </div>
                        </div>
                        <!-- Scrollable Table -->
                        <div class="max-h-[500px] overflow-y-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-gray-100/50 dark:bg-black/20 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider text-xs sticky top-0 backdrop-blur-md">
                                    <tr>
                                        <th class="px-6 py-4">VIN</th>
                                        <th class="px-6 py-4">HS Code</th>
                                        <th class="px-6 py-4">Packing</th>
                                        <th class="px-6 py-4">Source File</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-hs" class="divide-y divide-gray-200 dark:divide-gray-800">
                                    <!-- JS Injection -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Loading -->
                <div id="loading-hs" class="hidden flex-col items-center justify-center py-12">
                    <div
                        class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-600 rounded-full animate-spin mb-4">
                    </div>
                    <p class="text-purple-500 font-medium animate-pulse">Processing files...</p>
                </div>
            </div>

            <!-- TAB 4: CoC Extractor (WIP) -->
            <div id="content-coc" class="tab-content hidden animate-fade-in">
                <div
                    class="bg-surface-card dark:bg-surface-cardDark border border-gray-200 dark:border-gray-700/50 rounded-[2.5rem] p-12 text-center shadow-2xl shadow-gray-200/20 dark:shadow-none">
                    <div
                        class="w-20 h-20 bg-emerald-50 dark:bg-emerald-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="file-check" class="w-10 h-10 text-emerald-600 dark:text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">CoC Extractor</h2>
                    <p class="text-gray-500 max-w-md mx-auto">Validate Certificates of Conformity against VIN lists.</p>
                    <div class="mt-8">
                        <span
                            class="inline-flex items-center px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 border border-gray-200 dark:border-gray-700">
                            Coming Soon
                        </span>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs font-medium uppercase tracking-widest mt-auto">
        <p>Martin's Tools &copy; 2025</p>
    </footer>

</div>

<script>
    let hsDataCache = []; // Store HS data for export

    // --- TABS LOGIC ---
    function switchTab(tabName) {
        // 1. Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

        // 2. Reset all pill styles
        const allTabs = document.querySelectorAll('[id^="tab-"]');
        allTabs.forEach(btn => {
            btn.className = "relative z-10 px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-out flex items-center gap-2 group text-gray-500 hover:text-gray-900 dark:hover:text-white hover:bg-white/50 dark:hover:bg-white/5";
        });

        // 3. Show active content
        const activeContent = document.getElementById(`content-${tabName}`);
        if (activeContent) activeContent.classList.remove('hidden');

        // 4. Style active pill
        const activeBtn = document.getElementById(`tab-${tabName}`);
        if (activeBtn) {
            activeBtn.className = "relative z-10 px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 ease-out flex items-center gap-2 shadow-lg scale-105 bg-white text-black dark:bg-gray-800 dark:text-white dark:border dark:border-gray-700 ring-1 ring-black/5 dark:ring-white/10";
        }

        // Update URL Cleanly
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);
    }

    // --- A.TR LOGIC ---
    const dropZoneAtr = document.getElementById('drop-zone-atr');
    const fileInputAtr = document.getElementById('file-input-atr');
    const resultsAreaAtr = document.getElementById('results-area-atr');
    const resultsBodyAtr = document.getElementById('results-body-atr');
    const loadingAtr = document.getElementById('loading-atr');

    dropZoneAtr.addEventListener('click', () => fileInputAtr.click());
    dropZoneAtr.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneAtr.classList.add('border-indigo-500', 'bg-indigo-50/10'); });
    dropZoneAtr.addEventListener('dragleave', () => { dropZoneAtr.classList.remove('border-indigo-500', 'bg-indigo-50/10'); });
    dropZoneAtr.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneAtr.classList.remove('border-indigo-500', 'bg-indigo-50/10');
        if (e.dataTransfer.files.length) handleFilesAtr(e.dataTransfer.files);
    });
    fileInputAtr.addEventListener('change', (e) => {
        if (e.target.files.length) handleFilesAtr(e.target.files);
    });

    function handleFilesAtr(files) {
        loadingAtr.classList.remove('hidden');
        resultsAreaAtr.classList.remove('hidden');
        Array.from(files).forEach(file => uploadAndProcessAtr(file));
    }

    async function uploadAndProcessAtr(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/api/extract-atr', { method: 'POST', body: formData });
            const data = await response.json();
            if (response.ok) addResultRowAtr(data);
            else addErrorRowAtr(file.name, data.error);
        } catch (err) {
            addErrorRowAtr(file.name, "Network Error");
        } finally {
            loadingAtr.classList.add('hidden');
        }
    }

    function addResultRowAtr(data) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group";
        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white flex items-center gap-3"><i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i> ${data.filename}</td>
            <td class="px-6 py-4"><span class="font-mono text-indigo-600 dark:text-indigo-400 font-bold bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded select-all">${data.atr}</span></td>
            <td class="px-6 py-4"><span class="font-mono text-emerald-600 dark:text-emerald-400 font-bold bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded select-all">${data.invoice}</span></td>
        `;
        resultsBodyAtr.prepend(tr);
        lucide.createIcons();
    }

    function addErrorRowAtr(filename, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-6 py-4 font-medium flex gap-3"><i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i> ${filename}</td><td colspan="2" class="px-6 py-4 text-red-500 italic">${msg}</td>`;
        resultsBodyAtr.prepend(tr);
        lucide.createIcons();
    }

    function clearResultsAtr() {
        resultsBodyAtr.innerHTML = '';
        resultsAreaAtr.classList.add('hidden');
        fileInputAtr.value = '';
    }

    // --- HS CODE EXTRACTOR LOGIC ---
    const dropZoneHs = document.getElementById('drop-zone-hs');
    const fileInputHs = document.getElementById('file-input-hs');
    const resultsAreaHs = document.getElementById('results-area-hs');
    const resultsBodyHs = document.getElementById('results-body-hs');
    const loadingHs = document.getElementById('loading-hs');

    dropZoneHs.addEventListener('click', () => fileInputHs.click());
    dropZoneHs.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneHs.classList.add('border-purple-500', 'bg-purple-50/10'); });
    dropZoneHs.addEventListener('dragleave', () => { dropZoneHs.classList.remove('border-purple-500', 'bg-purple-50/10'); });
    dropZoneHs.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneHs.classList.remove('border-purple-500', 'bg-purple-50/10');
        if (e.dataTransfer.files.length) handleFilesHs(e.dataTransfer.files);
    });
    fileInputHs.addEventListener('change', (e) => {
        if (e.target.files.length) handleFilesHs(e.target.files);
    });

    function handleFilesHs(files) {
        loadingHs.classList.remove('hidden');
        resultsAreaHs.classList.remove('hidden');
        Array.from(files).forEach(file => uploadAndProcessHs(file));
    }

    async function uploadAndProcessHs(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/api/extract-hs', { method: 'POST', body: formData });
            const data = await response.json();

            if (response.ok && data.results) {
                // If success, data.results is a list of rows
                data.results.forEach(row => {
                    addResultRowHs(row);
                    hsDataCache.push(row);
                });
            } else {
                addErrorRowHs(file.name, data.error || "Unknown Error");
            }
        } catch (err) {
            addErrorRowHs(file.name, "Network Error: " + err);
        } finally {
            loadingHs.classList.add('hidden');
        }
    }

    function addResultRowHs(row) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group";
        tr.innerHTML = `
            <td class="px-6 py-3 font-mono text-gray-900 dark:text-white">${row.vin}</td>
            <td class="px-6 py-3 font-mono text-purple-600 dark:text-purple-400 font-bold">${row.hs}</td>
            <td class="px-6 py-3 text-gray-500">${row.packing}</td>
            <td class="px-6 py-3 text-xs text-gray-400 max-w-[150px] truncate" title="${row.file}">${row.file}</td>
        `;
        resultsBodyHs.prepend(tr);
        // Scroll to top of table to see new results
        resultsBodyHs.parentElement.parentElement.scrollTop = 0;
    }

    function addErrorRowHs(filename, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="px-6 py-4 text-red-500 italic border-l-4 border-red-500 bg-red-50/10">Error in ${filename}: ${msg}</td>`;
        resultsBodyHs.prepend(tr);
    }

    function clearResultsHs() {
        resultsBodyHs.innerHTML = '';
        resultsAreaHs.classList.add('hidden');
        fileInputHs.value = '';
        hsDataCache = [];
    }

    function downloadHsExcel() {
        if (hsDataCache.length === 0) return alert("No data to export!");

        const worksheet = XLSX.utils.json_to_sheet(hsDataCache);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "HS Extracted");
        XLSX.writeFile(workbook, "HS_Extraction_Results.xlsx");
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab') || '{{ active_tab }}' || 'customs';
        switchTab(activeTab);
    });
</script>
{% endblock %}