{% extends "base.html" %}

{% block content %}
<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { surface: { card: '#ffffff', cardDark: '#1c1c1e' } } } } }
</script>

<div class="max-w-4xl mx-auto px-4 py-8">

    <div class="mb-6 flex items-center justify-between">
        <div>
            <a href="{{ url_for('vw_carinjenje') }}"
                class="text-sm text-gray-400 hover:text-white mb-1 inline-flex items-center gap-1"><i
                    data-lucide="arrow-left" class="w-3 h-3"></i> Back to Hub</a>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">A.TR Extractor</h1>
        </div>
    </div>

    <!-- Upload Area -->
    <div id="drop-zone-atr"
        class="relative group overflow-hidden bg-white dark:bg-white/5 border-[3px] border-dashed border-gray-200 dark:border-gray-700 rounded-[2.5rem] p-16 text-center cursor-pointer transition-all hover:border-indigo-500/50 hover:shadow-2xl hover:shadow-indigo-500/5 mb-8">
        <input type="file" id="file-input-atr" class="hidden" accept=".pdf, .jpg, .jpeg, .png">
        <div
            class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
        </div>
        <div class="relative z-10 flex flex-col items-center gap-4">
            <div
                class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-3xl mb-2 group-hover:scale-110 transition-transform duration-300 shadow-sm">
                <i data-lucide="scan-line" class="w-10 h-10 text-indigo-600 dark:text-indigo-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Upload A.TR Document</h2>
            <p class="text-gray-500 dark:text-gray-400 font-medium">Supported: .pdf, .jpg, .png</p>
            <button onclick="document.getElementById('file-input-atr').click()"
                class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3.5 rounded-full font-semibold shadow-lg shadow-indigo-600/30 transition-all active:scale-95 flex items-center gap-2 tracking-wide">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                Select File
            </button>
        </div>
    </div>

    <!-- Results Table -->
    <div id="results-area-atr" class="hidden">
        <div
            class="bg-white dark:bg-white/5 border border-gray-200 dark:border-gray-800 rounded-3xl overflow-hidden shadow-xl">
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white">Analysis Results</h3>
                <button onclick="clearResultsAtr()"
                    class="text-sm text-gray-500 hover:text-red-500 transition-colors font-bold px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Clear</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead
                        class="bg-gray-100/50 dark:bg-black/20 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider text-xs">
                        <tr>
                            <th class="px-6 py-4">Filename</th>
                            <th class="px-6 py-4">A.TR Number</th>
                            <th class="px-6 py-4">Invoice Number</th>
                        </tr>
                    </thead>
                    <tbody id="results-body-atr" class="divide-y divide-gray-200 dark:divide-gray-800">
                        <!-- JS Injection -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading-atr" class="hidden flex flex-col items-center justify-center py-12">
        <div class="w-12 h-12 border-4 border-indigo-500/30 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p class="text-indigo-500 font-medium animate-pulse">Analyzing document...</p>
    </div>

</div>

<script>
    lucide.createIcons();

    const dropZoneAtr = document.getElementById('drop-zone-atr');
    const fileInputAtr = document.getElementById('file-input-atr');
    const resultsAreaAtr = document.getElementById('results-area-atr');
    const resultsBodyAtr = document.getElementById('results-body-atr');
    const loadingAtr = document.getElementById('loading-atr');

    dropZoneAtr.addEventListener('click', () => fileInputAtr.click());
    dropZoneAtr.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneAtr.classList.add('border-indigo-500', 'bg-indigo-50/10'); });
    dropZoneAtr.addEventListener('dragleave', () => { dropZoneAtr.classList.remove('border-indigo-500', 'bg-indigo-50/10'); });
    dropZoneAtr.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneAtr.classList.remove('border-indigo-500', 'bg-indigo-50/10');
        if (e.dataTransfer.files.length) handleFilesAtr(e.dataTransfer.files);
    });
    fileInputAtr.addEventListener('change', (e) => {
        if (e.target.files.length) handleFilesAtr(e.target.files);
    });

    function handleFilesAtr(files) {
        loadingAtr.classList.remove('hidden');
        resultsAreaAtr.classList.remove('hidden');
        Array.from(files).forEach(file => uploadAndProcessAtr(file));
    }

    async function uploadAndProcessAtr(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/api/extract-atr', { method: 'POST', body: formData });
            const data = await response.json();
            if (response.ok) addResultRowAtr(data);
            else addErrorRowAtr(file.name, data.error);
        } catch (err) {
            addErrorRowAtr(file.name, "Network Error");
        } finally {
            loadingAtr.classList.add('hidden');
        }
    }

    function addResultRowAtr(data) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group";
        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white flex items-center gap-3"><i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i> ${data.filename}</td>
            <td class="px-6 py-4"><span class="font-mono text-indigo-600 dark:text-indigo-400 font-bold bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded select-all">${data.atr}</span></td>
            <td class="px-6 py-4"><span class="font-mono text-emerald-600 dark:text-emerald-400 font-bold bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded select-all">${data.invoice}</span></td>
        `;
        resultsBodyAtr.prepend(tr);
        lucide.createIcons();
    }

    function addErrorRowAtr(filename, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-6 py-4 font-medium flex gap-3"><i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i> ${filename}</td><td colspan="2" class="px-6 py-4 text-red-500 italic">${msg}</td>`;
        resultsBodyAtr.prepend(tr);
        lucide.createIcons();
    }

    function clearResultsAtr() {
        resultsBodyAtr.innerHTML = '';
        resultsAreaAtr.classList.add('hidden');
        fileInputAtr.value = '';
    }
</script>
{% endblock %}