{% extends 'base.html' %}

{% block content %}
<div class="glass-panel"
    style="margin-bottom: 20px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1 class="text-glow" style="margin: 0; font-size: 1.8rem;">Dashboard</h1>
        <p style="margin: 5px 0 0 0; color: var(--text-muted);">Welcome back, {{ user.name }}</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="openSettingsModal()" class="btn glass-btn"
            style="background: linear-gradient(135deg, var(--accent-color) 0%, #9b59b6 100%); color: white; border: none; padding: 10px 20px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); font-weight: 600; font-size: 0.9rem;">
            <i class="fas fa-plus-minus"></i> Add/Remove
        </button>
        <button id="rearrangeBtn" onclick="toggleRearrangeMode()" class="btn glass-btn"
            style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 10px 20px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); font-weight: 600; font-size: 0.9rem;">
            <i class="fas fa-arrows-alt"></i> Re-arrange
        </button>
    </div>
</div>

<!-- Configurable Grid -->
<div class="content-grid" id="dashboardGrid"
    style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); grid-auto-flow: dense;">

    <!-- KPI WIDGETS -->
    <div class="card glass-panel" data-widget="kpi_stock">
        <div class="card-header"><i class="fas fa-cubes"></i> System Stock</div>
        <div class="card-body">
            <h2 class="text-glow">12,450</h2>
        </div>
    </div>

    <div class="card glass-panel" data-widget="kpi_dispatched">
        <div class="card-header"><i class="fas fa-shipping-fast"></i> Dispatched Today</div>
        <div class="card-body">
            <h2 class="text-glow">840</h2>
        </div>
    </div>

    <div class="card glass-panel" data-widget="kpi_loading">
        <div class="card-header"><i class="fas fa-train"></i> Loading Plan (Wagons)</div>
        <div class="card-body">
            <h2 class="text-glow">45 / 50</h2>
        </div>
    </div>

    <div class="card glass-panel" data-widget="kpi_customs">
        <div class="card-header"><i class="fas fa-file-contract"></i> Pending Customs</div>
        <div class="card-body">
            <h2 class="text-glow" style="color: #ffcc00;">12</h2>
        </div>
    </div>

    <!-- DAILY TASKS WIDGET -->
    <div class="card glass-panel" data-widget="daily_tasks_widget" style="grid-row: span 2;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-tasks"></i> Daily Tasks <span id="taskProgressPill"
                    style="margin-left: 10px; padding: 3px 10px; background: rgba(46, 204, 113, 0.2); color: #2ecc71; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"></span></span>
            <a href="{{ url_for('daily_tasks') }}"
                style="font-size: 0.8rem; color: var(--accent-color); text-decoration: none;">View All</a>
        </div>
        <!-- Progress Bar -->
        <div id="taskProgressBar"
            style="width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; margin: 10px 0; overflow: hidden;">
            <div id="taskProgressFill"
                style="width: 0%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); border-radius: 3px; transition: width 0.5s ease;">
            </div>
        </div>
        <div class="card-body" style="align-items: flex-start; padding-top: 0; width: 100%;">
            <div id="dashboardTaskList" style="width: 100%; display: flex; flex-direction: column; gap: 8px;">
                <div style="color: var(--text-muted); font-size: 0.9rem;">Loading tasks...</div>
            </div>
        </div>
    </div>

    <!-- PROJECTS WIDGET -->
    <div class="card glass-panel" data-widget="projects_widget" style="grid-row: span 2;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-layer-group"></i> My Projects</span>
            <a href="{{ url_for('projects_board') }}"
                style="font-size: 0.8rem; color: var(--accent-color); text-decoration: none;">Open Board</a>
        </div>
        <div class="card-body"
            style="flex-direction: column; align-items: stretch; gap: 8px; padding-top: 10px; width: 100%;">
            <div id="myProjectsList" style="display: flex; flex-direction: column; gap: 8px;">
                <div style="color: var(--text-muted); font-size: 0.9rem;">Loading projects...</div>
            </div>
        </div>
    </div>
</div>

</div>

<!-- Settings Modal (One UI Style) -->
<div id="settingsModal" class="modal-overlay"
    style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;">
    <div class="glass-panel"
        style="width: 400px; max-width: 90%; padding: 0; overflow: hidden; transform: scale(0.9); transition: transform 0.3s;">

        <div
            style="padding: 20px 25px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
            <h3 style="margin: 0; font-size: 1.1rem;">Customize Dashboard</h3>
            <button onclick="closeSettingsModal()"
                style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;"><i
                    class="fas fa-times"></i></button>
        </div>

        <div style="padding: 25px; max-height: 60vh; overflow-y: auto;">
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Toggle visibility of widgets.
            </p>

            <div id="widgetList" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Items with Icons -->
                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(108, 92, 231, 0.2); display: flex; align-items: center; justify-content: center; color: var(--accent-color);">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <span style="font-weight: 500;">System Stock</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="kpi_stock" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>

                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(241, 196, 15, 0.2); display: flex; align-items: center; justify-content: center; color: #f1c40f;">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <span style="font-weight: 500;">Dispatched</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="kpi_dispatched" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>

                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(52, 152, 219, 0.2); display: flex; align-items: center; justify-content: center; color: #3498db;">
                            <i class="fas fa-train"></i>
                        </div>
                        <span style="font-weight: 500;">Loading Plan</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="kpi_loading" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>

                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(231, 76, 60, 0.2); display: flex; align-items: center; justify-content: center; color: #e74c3c;">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <span style="font-weight: 500;">Pending Customs</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="kpi_customs" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>

                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(46, 204, 113, 0.2); display: flex; align-items: center; justify-content: center; color: #2ecc71;">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <span style="font-weight: 500;">Daily Tasks</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="daily_tasks_widget" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>

                <div class="custom-setting-row" onclick="toggleWidgetRow(this, event)"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: rgba(155, 89, 182, 0.2); display: flex; align-items: center; justify-content: center; color: #9b59b2;">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <span style="font-weight: 500;">Projects Shortcut</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" value="projects_widget" style="display:none;"
                            onchange="this.parentElement.classList.toggle('active', this.checked)">
                    </label>
                </div>
            </div>
        </div>

        <div
            style="padding: 20px; border-top: 1px solid var(--glass-border); text-align: right; background: rgba(0,0,0,0.1);">
            <button onclick="saveSettings()" class="pill-btn primary"
                style="background: var(--accent-color); color: white; border: none; padding: 12px 30px; border-radius: 50px !important;">Save
                Changes</button>
        </div>
    </div>
</div>

<!-- Rearrange Modal -->
<div id="rearrangeModal" class="modal-overlay"
    style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;">
    <div class="glass-panel"
        style="width: 400px; max-width: 90%; padding: 0; overflow: hidden; transform: scale(0.9); transition: transform 0.3s;">

        <div
            style="padding: 20px 25px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(52, 152, 219, 0.1);">
            <h3 style="margin: 0; font-size: 1.1rem;"><i class="fas fa-arrows-alt"
                    style="margin-right: 10px; color: #3498db;"></i>Re-arrange Widgets</h3>
            <button onclick="closeRearrangeModal()"
                style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;"><i
                    class="fas fa-times"></i></button>
        </div>

        <div style="padding: 25px;">
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Drag widgets to reorder them on
                your dashboard.</p>

            <div id="rearrangeList" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Populated by JS -->
            </div>
        </div>

        <div
            style="padding: 20px; border-top: 1px solid var(--glass-border); text-align: right; background: rgba(0,0,0,0.1);">
            <button onclick="saveRearrange()" class="pill-btn primary"
                style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 30px; border-radius: 50px !important;">Apply
                Order</button>
        </div>
    </div>
</div>

<style>
    .rearrange-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: grab;
        transition: all 0.2s;
    }

    .rearrange-item:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(52, 152, 219, 0.3);
    }

    .rearrange-item:active {
        cursor: grabbing;
    }

    /* Smooth rearrange animations */
    #dashboardGrid.rearrange-mode {
        gap: 20px;
    }

    #dashboardGrid.rearrange-mode [data-widget] {
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
            opacity 0.2s ease,
            border-color 0.2s ease,
            box-shadow 0.2s ease;
    }

    #dashboardGrid.rearrange-mode [data-widget].dragging {
        opacity: 0.6;
        transform: scale(0.98);
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    #dashboardGrid.rearrange-mode [data-widget]:not(.dragging) {
        transform: translateY(0);
    }

    #dashboardGrid.rearrange-mode [data-widget].drag-over {
        border-color: rgba(46, 204, 113, 0.8) !important;
        transform: scale(1.02);
    }
</style>
<script>
    // Load settings on init
    document.addEventListener('DOMContentLoaded', () => {
        // Load User Settings
        fetch('/api/user/settings')
            .then(r => r.json())
            .then(data => {
                applyDashboardSettings(data.dashboard_layout);
                updateToggles(data.dashboard_layout);
            });

        // Load Mini Tasks and Projects
        loadMiniTasks();
        loadMyProjects();
    });

    function loadMiniTasks() {
        fetch(`/api/tasks?date=${new Date().toISOString().split('T')[0]}`)
            .then(r => r.json())
            .then(tasks => {
                const container = document.getElementById('dashboardTaskList');
                const progressPill = document.getElementById('taskProgressPill');
                const progressFill = document.getElementById('taskProgressFill');
                container.innerHTML = '';

                // Update progress
                const completed = tasks.filter(t => t.completed).length;
                const total = tasks.length;
                if (total > 0) {
                    const pct = Math.round((completed / total) * 100);
                    progressPill.innerHTML = `${completed}/${total}`;
                    progressPill.style.background = pct === 100 ? 'rgba(46, 204, 113, 0.3)' : 'rgba(241, 196, 15, 0.2)';
                    progressPill.style.color = pct === 100 ? '#2ecc71' : '#f1c40f';
                    progressFill.style.width = pct + '%';
                    progressFill.style.background = pct === 100 ? 'linear-gradient(90deg, #2ecc71, #27ae60)' : 'linear-gradient(90deg, #f1c40f, #e67e22)';
                } else {
                    progressPill.innerHTML = '';
                    progressFill.style.width = '0%';
                }

                if (tasks.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">No tasks logged today.</div>';
                    return;
                }

                // Sort: incomplete first, then completed
                const sortedTasks = [...tasks].sort((a, b) => {
                    if (a.completed === b.completed) return 0;
                    return a.completed ? 1 : -1;
                });

                const recent = sortedTasks.slice(0, 5);
                recent.forEach(t => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 6px 0; cursor: pointer;';
                    div.innerHTML = `
                        <i class="fas ${t.completed ? 'fa-check-circle' : 'fa-circle'}" 
                           style="font-size: 0.9rem; color: ${t.completed ? '#2ecc71' : '#555'}; transition: all 0.2s;"
                           onmouseover="this.style.color='${t.completed ? '#27ae60' : '#2ecc71'}'; this.style.transform='scale(1.2)';"
                           onmouseout="this.style.color='${t.completed ? '#2ecc71' : '#555'}'; this.style.transform='scale(1)';"></i>
                        <span style="font-size: 0.85rem; flex: 1; ${t.completed ? 'text-decoration: line-through; color: #666;' : ''}">${t.title}</span>
                    `;
                    div.onclick = () => toggleDashboardTask(t.id, !t.completed);
                    container.appendChild(div);
                });
                if (tasks.length > 5) {
                    container.innerHTML += `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; padding-left: 20px;">+ ${tasks.length - 5} more...</div>`
                }
            });
    }

    function toggleDashboardTask(id, completed) {
        fetch('/api/tasks', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, completed })
        }).then(() => loadMiniTasks());
    }

    function loadMyProjects() {
        fetch('/api/projects')
            .then(r => r.json())
            .then(projects => {
                const container = document.getElementById('myProjectsList');
                container.innerHTML = '';

                const username = '{{ session.username }}';
                const myProjects = projects.filter(p => !p.archived && p.assignees && p.assignees.includes(username));

                if (myProjects.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">No projects assigned.</div>';
                    return;
                }

                const statusColors = {
                    'todo': '#95a5a6',
                    'in_progress': '#3498db',
                    'on_hold': '#f39c12',
                    'done': '#2ecc71'
                };
                const statusLabels = {
                    'todo': 'Not started',
                    'in_progress': 'In progress',
                    'on_hold': 'On hold',
                    'done': 'Finished'
                };

                myProjects.slice(0, 4).forEach(p => {
                    const dueDate = p.due_date ? new Date(p.due_date) : null;
                    const today = new Date();
                    const isOverdue = dueDate && dueDate < today && p.status !== 'done';
                    const dueDateStr = dueDate ? dueDate.toLocaleDateString('sl-SI', { day: 'numeric', month: 'short' }) : '';

                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 600; font-size: 0.9rem;">${p.title}</span>
                            <span style="padding: 2px 8px; background: ${statusColors[p.status]}22; color: ${statusColors[p.status]}; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">${statusLabels[p.status] || p.status}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.75rem; color: ${isOverdue ? '#e74c3c' : 'var(--text-muted)'};">
                                ${dueDate ? `<i class="fas fa-calendar-alt" style="margin-right: 4px;"></i>${dueDateStr}` : '<span style="opacity: 0.5;">No deadline</span>'}
                                ${isOverdue ? ' <span style="color: #e74c3c; font-weight: 600;">Overdue</span>' : ''}
                            </span>
                            <span style="font-size: 0.7rem; padding: 2px 6px; background: rgba(${p.category === 'Toyota' ? '231, 76, 60' : p.category === 'Volkswagen' ? '52, 152, 219' : '155, 89, 182'}, 0.2); color: ${p.category === 'Toyota' ? '#e74c3c' : p.category === 'Volkswagen' ? '#3498db' : '#9b59b6'}; border-radius: 6px;">${p.category || 'Others'}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
                if (myProjects.length > 4) {
                    container.innerHTML += `<div style="font-size: 0.75rem; color: var(--text-muted); text-align: center; padding: 5px;">+ ${myProjects.length - 4} more projects</div>`;
                }
            });
    }

    function openSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        // Animation
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.querySelector('.glass-panel').style.transform = 'scale(1)';
        }, 10);
    }

    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.style.opacity = '0';
        modal.querySelector('.glass-panel').style.transform = 'scale(0.9)';
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function saveSettings() {
        const checkboxes = document.querySelectorAll('#widgetList input[type="checkbox"]');
        const selected = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);

        fetch('/api/user/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 'dashboard_layout': selected })
        }).then(r => r.json()).then(resp => {
            if (resp.success) {
                applyDashboardSettings(selected);
                closeSettingsModal();
            } else {
                alert('Error saving settings');
            }
        });
    }

    function applyDashboardSettings(layout) {
        // Toggle Widgets
        document.querySelectorAll('[data-widget]').forEach(el => {
            if (layout.includes(el.dataset.widget)) {
                el.style.display = 'flex'; // Card layout is flex
            } else {
                el.style.display = 'none';
            }
        });
    }

    function updateToggles(layout) {
        document.querySelectorAll('#widgetList input[type="checkbox"]').forEach(cb => {
            cb.checked = layout.includes(cb.value);
            // Toggle visual class
            cb.parentElement.classList.toggle('active', cb.checked);
        });
    }

    function toggleWidgetRow(row, event) {
        // Only toggle if we didn't click the label itself (prevent double toggle)
        if (event.target.tagName !== 'LABEL' && !event.target.closest('.toggle-switch')) {
            const checkbox = row.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            // Trigger the onchange manually
            checkbox.dispatchEvent(new Event('change'));
        }
    }

    // === DIRECT DASHBOARD REARRANGE ===
    let isRearrangeMode = false;
    let dragSrcWidget = null;

    function toggleRearrangeMode() {
        isRearrangeMode = !isRearrangeMode;
        const btn = document.getElementById('rearrangeBtn');
        const grid = document.getElementById('dashboardGrid');
        const widgets = grid.querySelectorAll('[data-widget]');

        if (isRearrangeMode) {
            // Enter rearrange mode
            btn.innerHTML = '<i class="fas fa-check"></i> Save Layout';
            btn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
            btn.style.boxShadow = '0 4px 15px rgba(46, 204, 113, 0.4)';
            grid.classList.add('rearrange-mode');

            widgets.forEach(w => {
                if (w.style.display !== 'none') {
                    w.draggable = true;
                    w.style.cursor = 'grab';
                    w.style.border = '2px dashed rgba(52, 152, 219, 0.5)';
                    w.addEventListener('dragstart', widgetDragStart);
                    w.addEventListener('dragover', widgetDragOver);
                    w.addEventListener('dragleave', widgetDragLeave);
                    w.addEventListener('drop', widgetDrop);
                    w.addEventListener('dragend', widgetDragEnd);
                }
            });
        } else {
            // Exit rearrange mode (save)
            btn.innerHTML = '<i class="fas fa-arrows-alt"></i> Re-arrange';
            btn.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            btn.style.boxShadow = '0 4px 15px rgba(52, 152, 219, 0.3)';
            grid.classList.remove('rearrange-mode');

            widgets.forEach(w => {
                w.draggable = false;
                w.style.cursor = '';
                w.style.border = '';
                w.classList.remove('dragging', 'drag-over');
                w.removeEventListener('dragstart', widgetDragStart);
                w.removeEventListener('dragover', widgetDragOver);
                w.removeEventListener('dragleave', widgetDragLeave);
                w.removeEventListener('drop', widgetDrop);
                w.removeEventListener('dragend', widgetDragEnd);
            });
        }
    }

    let lastMoveTime = 0;
    const MOVE_THROTTLE = 150; // ms between moves for smoother animation

    function widgetDragStart(e) {
        dragSrcWidget = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);

        // Slight delay for better visual
        requestAnimationFrame(() => {
            this.style.opacity = '0.5';
        });
    }

    function widgetDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (dragSrcWidget === this) return;

        // Throttle moves for smoother animation
        const now = Date.now();
        if (now - lastMoveTime < MOVE_THROTTLE) return;
        lastMoveTime = now;

        const grid = document.getElementById('dashboardGrid');
        const targetRect = this.getBoundingClientRect();
        const targetCenterY = targetRect.top + targetRect.height / 2;
        const targetCenterX = targetRect.left + targetRect.width / 2;

        // Remove drag-over from all widgets
        grid.querySelectorAll('[data-widget]').forEach(w => w.classList.remove('drag-over'));
        this.classList.add('drag-over');

        // Determine position based on mouse
        const insertBefore = e.clientY < targetCenterY ||
            (e.clientY >= targetCenterY && e.clientX < targetCenterX);

        if (insertBefore) {
            grid.insertBefore(dragSrcWidget, this);
        } else {
            grid.insertBefore(dragSrcWidget, this.nextSibling);
        }
    }

    function widgetDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function widgetDrop(e) {
        e.stopPropagation();
        e.preventDefault();
        this.classList.remove('drag-over');
        return false;
    }

    function widgetDragEnd() {
        this.style.opacity = '';
        this.classList.remove('dragging');
        document.querySelectorAll('#dashboardGrid [data-widget]').forEach(w => {
            w.classList.remove('drag-over');
            if (isRearrangeMode) {
                w.style.borderColor = 'rgba(52, 152, 219, 0.5)';
            }
        });
    }
</script>
{% endblock %}