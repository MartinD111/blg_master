{% extends "base.html" %}

{% block content %}
<!-- Tool Specific Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                borderRadius: {
                    '4xl': '2rem',

                },
                colors: {
                    surface: {
                        light: '#f2f4f7',
                        dark: '#0b0b0b',
                        card: '#ffffff',
                        cardDark: '#1c1c1e',
                    },
                    primary: {
                        DEFAULT: '#4f46e5', // Indigo for A.TR
                        dark: '#6366f1'
                    }
                }
            }
        }
    }
</script>
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Main App Wrapper -->
<div id="vw-atr-tool"
    class="bg-transparent text-gray-900 dark:text-gray-100 min-h-screen flex flex-col selection:bg-primary selection:text-white">

    <main class="flex-grow p-4 md:p-8 max-w-4xl mx-auto w-full flex flex-col gap-8">

        <div class="flex justify-center mb-4 pt-8">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-gray-100">A.TR Extractor</h1>
        </div>

        <!-- Upload Area (Matches Current Situation style) -->
        <div id="drop-zone"
            class="relative group overflow-hidden bg-surface-card dark:bg-surface-cardDark border-[3px] border-dashed border-gray-200 dark:border-gray-700 rounded-4xl p-16 text-center cursor-pointer transition-all hover:border-primary/50 hover:shadow-2xl hover:shadow-primary/5">
            <input type="file" id="file-input" class="hidden" accept=".pdf, .jpg, .jpeg, .png">
            <div
                class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            </div>
            <div class="relative z-10 flex flex-col items-center gap-4">
                <div
                    class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-3xl mb-2 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="scan-line" class="w-10 h-10 text-primary dark:text-primary-dark"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Povleci in spusti dokument</h2>
                <p class="text-gray-500 dark:text-gray-400 font-medium">Podprto: .pdf, .jpg, .png</p>
                <div
                    class="mt-4 bg-primary hover:bg-indigo-700 text-white px-8 py-3.5 rounded-full font-semibold shadow-lg shadow-indigo-600/30 transition-all active:scale-95 flex items-center gap-2">
                    <i data-lucide="folder-open" class="w-4 h-4"></i>
                    Izberi datoteko
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div id="results-area" class="hidden">
            <div
                class="bg-surface-card dark:bg-surface-cardDark border border-gray-200 dark:border-gray-800 rounded-3xl overflow-hidden shadow-xl">
                <div
                    class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Rezultati Analize</h3>
                    <button onclick="clearResults()"
                        class="text-sm text-gray-500 hover:text-red-500 transition-colors font-medium">Počisti</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-gray-100 dark:bg-black/20 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider text-xs">
                            <tr>
                                <th class="px-6 py-4">Datoteka</th>
                                <th class="px-6 py-4">A.TR Številka</th>
                                <th class="px-6 py-4">Invoice Številka</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="divide-y divide-gray-200 dark:divide-gray-800">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-indicator" class="hidden flex-col items-center justify-center py-12">
            <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
            <p class="text-gray-500 font-medium animate-pulse">Analiziram dokument...</p>
        </div>

    </main>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    });

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const resultsArea = document.getElementById('results-area');
    const resultsBody = document.getElementById('results-body');
    const loading = document.getElementById('loading-indicator');

    // Drag & Drop Logic
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-primary/5', 'border-primary'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-primary/5', 'border-primary'); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('bg-primary/5', 'border-primary');
        if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFiles(e.target.files);
    });

    function handleFiles(files) {
        // Show loading, hide previous results if you want single-shot focus, 
        // or append if multi-file is desired. Let's append but show visible feedback.
        loading.classList.remove('hidden');
        resultsArea.classList.remove('hidden'); // Show table container immediately

        Array.from(files).forEach(file => {
            uploadAndProcess(file);
        });
    }

    async function uploadAndProcess(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/extract-atr', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                addResultRow(data);
            } else {
                addErrorRow(file.name, data.error || "Napaka na strežniku");
            }
        } catch (err) {
            addErrorRow(file.name, "Network Error");
        } finally {
            // Check if queue empty? For now just hide loading after each (simple logic)
            loading.classList.add('hidden');
        }
    }

    function addResultRow(data) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group";

        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white flex items-center gap-3">
                <i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i> ${data.filename}
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <span class="font-mono text-indigo-600 dark:text-indigo-400 font-bold bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded select-all">${data.atr}</span>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-indigo-500" onclick="copyToClipboard('${data.atr}')">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <span class="font-mono text-emerald-600 dark:text-emerald-400 font-bold bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded select-all">${data.invoice}</span>
                     <button class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-emerald-500" onclick="copyToClipboard('${data.invoice}')">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        `;
        resultsBody.prepend(tr); // Newest first
        lucide.createIcons();
    }

    function addErrorRow(filename, errorMsg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i> ${filename}
            </td>
            <td colspan="2" class="px-6 py-4 text-red-500 italic">
                ${errorMsg}
            </td>
        `;
        resultsBody.prepend(tr);
        lucide.createIcons();
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        // Optional: Toast notification here
    }

    function clearResults() {
        resultsBody.innerHTML = '';
        resultsArea.classList.add('hidden');
        fileInput.value = '';
    }
</script>
{% endblock %}