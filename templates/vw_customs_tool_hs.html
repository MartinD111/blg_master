{% extends "base.html" %}

{% block content %}
<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script>
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { surface: { card: '#ffffff', cardDark: '#1c1c1e' } } } } }
</script>

<div class="max-w-4xl mx-auto px-4 py-8">

    <div class="mb-6 flex items-center justify-between">
        <div>
            <a href="{{ url_for('vw_carinjenje') }}"
                class="text-sm text-gray-400 hover:text-white mb-1 inline-flex items-center gap-1"><i
                    data-lucide="arrow-left" class="w-3 h-3"></i> Back to Hub</a>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">HS Code Tool</h1>
        </div>
    </div>

    <!-- Upload Area -->
    <div id="drop-zone-hs"
        class="relative group overflow-hidden bg-white dark:bg-white/5 border-[3px] border-dashed border-gray-200 dark:border-gray-700 rounded-[2.5rem] p-16 text-center cursor-pointer transition-all hover:border-purple-500/50 hover:shadow-2xl hover:shadow-purple-500/5 mb-8">
        <input type="file" id="file-input-hs" class="hidden" accept=".zip, .xlsx, .xls">
        <div
            class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
        </div>
        <div class="relative z-10 flex flex-col items-center gap-4">
            <div
                class="bg-purple-50 dark:bg-purple-900/20 p-5 rounded-3xl mb-2 group-hover:scale-110 transition-transform duration-300 shadow-sm">
                <i data-lucide="file-archive" class="w-10 h-10 text-purple-600 dark:text-purple-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Upload Excel or ZIP</h2>
            <p class="text-gray-500 dark:text-gray-400 font-medium">Supported: .xlsx, .xls, .zip (with multiple Excels)
            </p>
            <button onclick="document.getElementById('file-input-hs').click()"
                class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-8 py-3.5 rounded-full font-semibold shadow-lg shadow-purple-600/30 transition-all active:scale-95 flex items-center gap-2 tracking-wide">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                Select File
            </button>
        </div>
    </div>

    <!-- Results Table -->
    <div id="results-area-hs" class="hidden">
        <div
            class="bg-white dark:bg-white/5 border border-gray-200 dark:border-gray-800 rounded-3xl overflow-hidden shadow-xl">
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white">Extracted Data</h3>
                <div class="flex gap-2">
                    <button onclick="downloadHsExcel()"
                        class="text-sm text-green-600 hover:text-green-700 font-bold px-3 py-1 rounded-lg bg-green-50 dark:bg-green-900/20">Download
                        Excel</button>
                    <button onclick="clearResultsHs()"
                        class="text-sm text-gray-500 hover:text-red-500 font-bold px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Clear</button>
                </div>
            </div>
            <div class="max-h-[500px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead
                        class="bg-gray-100/50 dark:bg-black/20 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider text-xs sticky top-0 backdrop-blur-md">
                        <tr>
                            <th class="px-6 py-4">VIN</th>
                            <th class="px-6 py-4">HS Code</th>
                            <th class="px-6 py-4">Packing</th>
                            <th class="px-6 py-4">Source File</th>
                        </tr>
                    </thead>
                    <tbody id="results-body-hs" class="divide-y divide-gray-200 dark:divide-gray-800">
                        <!-- JS Injection -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading-hs" class="hidden flex flex-col items-center justify-center py-12">
        <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-600 rounded-full animate-spin mb-4"></div>
        <p class="text-purple-500 font-medium animate-pulse">Processing files...</p>
    </div>

</div>

<script>
    lucide.createIcons();
    let hsDataCache = [];

    const dropZoneHs = document.getElementById('drop-zone-hs');
    const fileInputHs = document.getElementById('file-input-hs');
    const resultsAreaHs = document.getElementById('results-area-hs');
    const resultsBodyHs = document.getElementById('results-body-hs');
    const loadingHs = document.getElementById('loading-hs');

    dropZoneHs.addEventListener('click', () => fileInputHs.click());
    dropZoneHs.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneHs.classList.add('border-purple-500', 'bg-purple-50/10'); });
    dropZoneHs.addEventListener('dragleave', () => { dropZoneHs.classList.remove('border-purple-500', 'bg-purple-50/10'); });
    dropZoneHs.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneHs.classList.remove('border-purple-500', 'bg-purple-50/10');
        if (e.dataTransfer.files.length) handleFilesHs(e.dataTransfer.files);
    });
    fileInputHs.addEventListener('change', (e) => {
        if (e.target.files.length) handleFilesHs(e.target.files);
    });

    function handleFilesHs(files) {
        loadingHs.classList.remove('hidden');
        resultsAreaHs.classList.remove('hidden');
        Array.from(files).forEach(file => uploadAndProcessHs(file));
    }

    async function uploadAndProcessHs(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/api/extract-hs', { method: 'POST', body: formData });
            const data = await response.json();
            if (response.ok && data.results) {
                data.results.forEach(row => {
                    addResultRowHs(row);
                    hsDataCache.push(row);
                });
            } else {
                addErrorRowHs(file.name, data.error || "Unknown Error");
            }
        } catch (err) {
            addErrorRowHs(file.name, "Network Error: " + err);
        } finally {
            loadingHs.classList.add('hidden');
        }
    }

    function addResultRowHs(row) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group";
        tr.innerHTML = `
            <td class="px-6 py-3 font-mono text-gray-900 dark:text-white">${row.vin}</td>
            <td class="px-6 py-3 font-mono text-purple-600 dark:text-purple-400 font-bold">${row.hs}</td>
            <td class="px-6 py-3 text-gray-500">${row.packing}</td>
            <td class="px-6 py-3 text-xs text-gray-400 max-w-[150px] truncate" title="${row.file}">${row.file}</td>
        `;
        resultsBodyHs.prepend(tr);
        resultsBodyHs.parentElement.parentElement.scrollTop = 0;
    }

    function addErrorRowHs(filename, msg) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="px-6 py-4 text-red-500 italic border-l-4 border-red-500 bg-red-50/10">Error in ${filename}: ${msg}</td>`;
        resultsBodyHs.prepend(tr);
    }

    function clearResultsHs() {
        resultsBodyHs.innerHTML = '';
        resultsAreaHs.classList.add('hidden');
        fileInputHs.value = '';
        hsDataCache = [];
    }

    function downloadHsExcel() {
        if (hsDataCache.length === 0) return alert("No data to export!");
        const worksheet = XLSX.utils.json_to_sheet(hsDataCache);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "HS Extracted");
        XLSX.writeFile(workbook, "HS_Extraction_Results.xlsx");
    }
</script>
{% endblock %}